# Конфигурация ArgoCD

## **ВНИМАНИЕ**

**Этот репозиторий не следует изменять, если вы не уверены на 100%, что понимаете, что делаете.**

## Описание

Этот репозиторий содержит все конфигурационные файлы ArgoCD и развертывается самим ArgoCD.
Каждое изменение, которое попадает в главную ветку этого репозитория, будет автоматически подхвачено ArgoCD и применено.

ArgoCD является критически важным компонентом инфраструктуры JJOInvest и настроен для развертывания самого себя из этого репозитория.
Изменения, внесенные в этот репозиторий, могут повлиять на нашу централизованную инстанцию ArgoCD.

## Инструкции

### Добавление новых кластеров под контроль ArgoCD

1. [Установить ArgoCD CLI](https://argo-cd.readthedocs.io/en/stable/cli_installation/).
2. Добавить кластер, который мы хотим контроллировать с помощью ArgoCD, в локальный kubeconfig.

    [EKS инструкции.](https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html)
3. В отдельном терминале запустить:

    ```bash
    kubectl port-forward svc/argocd-server -n argocd 8081:80 --context <контекст кластера с арго>
    ```

4. Запустить:

    ```bash
    argocd cluster add <имя контекста кластера, который хотим добавить>
    ```

5. Переключив контекст на кластер, в котором живет Арго, запустить:

    ```bash
    kubectl get secret
    ```

    и найти секрет, который мы создали шагом выше (AGE будет самый маленький из всех).

6. `kubectl get secret <имя секрета из прошлого шага> -o yaml > cluster-secret.yaml`
7. Убираем из файла всю ненужную Kubernetes метадату (либо руками либо с помощью [kubectl-neat](https://github.com/itaysk/kubectl-neat)) и копируем его в папку `clusters` в этом репозитории, предварительно назвав его в честь кластера и добавляем этот файл в `kustomization.yaml` в этой же папке.
8. Открываем новый PR и мерджим эти изменения в главную ветку.
